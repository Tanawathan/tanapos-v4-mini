# **結帳系統：定義與規則**

## **1\. 系統目標**

**結帳系統** 的核心目標是提供一個安全、高效且靈活的支付處理流程。此系統必須確保每一筆交易的準確性，支援多種支付方式，自動化更新相關的訂單與桌位狀態，並在最終生成清晰的收據，以保障餐廳與顧客雙方的權益。

## **2\. 核心資料結構**

結帳流程圍繞著「交易」與「收據」兩個核心概念運作：

* **交易 (Transaction):**  
  * **交易ID (transactionId):** 系統為每一次支付嘗試生成的唯一識別碼。  
  * **訂單ID (orderId):** 與此交易關聯的訂單。  
  * **交易金額 (amount):** 本次支付的金額。  
  * **支付方式 (paymentMethod):** 例如：現金、信用卡、電子錢包。  
  * **交易狀態 (status):** 描述該次支付嘗試的結果。  
  * **交易時間 (transactionTime):** 支付發生的時間。  
* **收據 (Receipt):**  
  * **收據ID (receiptId):** 成功交易後生成的唯一收據號碼。  
  * **訂單詳情 (orderDetails):** 包含所有消費項目、數量、單價及小計。  
  * **付款資訊 (paymentDetails):** 顯示總金額、稅額、服務費、折扣及最終支付方式。  
  * **餐廳資訊 (restaurantInfo):** 餐廳的名稱、地址、電話和統一編號。

## **3\. 交易狀態定義**

每一次的支付嘗試都會有以下其中一種狀態：

* **🟠 待付款 (Pending):**  
  * **定義:** 已啟動結帳流程，但尚未選擇支付方式或進行支付。  
  * **規則:** 這是結帳流程的初始狀態。  
* **🟡 處理中 (Processing):**  
  * **定義:** 系統正在與第三方支付服務（如信用卡終端機或電子錢包 API）進行通訊。  
  * **規則:** 在此狀態下，介面應顯示等待訊息，防止重複操作。  
* **🟢 已付款 (Paid):**  
  * **定義:** 支付已成功完成。  
  * **規則:** 這是成功交易的最終狀態。  
* **🔴 付款失敗 (Failed):**  
  * **定義:** 由於餘額不足、連線逾時或顧客取消等原因，支付未能成功。  
  * **規則:** 系統應提供明確的失敗原因，並允許服務人員重新嘗試或更換支付方式。

## **4\. 標準作業流程 (SOP)**

所有結帳操作必須嚴格遵循以下程序：

1. **啟動結帳:**  
   * **前提:** TableStatus (桌位狀態) 為 🔵 用餐中。  
   * **動作:** 服務人員在 POS 系統上選擇目標桌位並點擊「結帳」。  
   * **系統反應:**  
     * 系統自動計算包含服務費與稅金的最終帳單金額。  
     * 對應的 TableStatus 從 🔵 用餐中 更新為 🟠 待付款。  
2. **選擇支付方式:**  
   * **動作:** 服務人員向顧客確認帳單金額，並詢問其希望使用的支付方式。  
   * **系統反應:** 服務人員在系統上選擇對應的支付方式（例如：現金、信用卡）。  
3. **處理支付:**  
   * **現金支付:** 服務人員輸入顧客支付的金額，系統自動計算並顯示應找零的金額。確認後，Transaction 狀態直接更新為 🟢 已付款。  
   * **電子支付 (信用卡/電子錢包):**  
     * 系統觸發支付終端機或顯示 QR Code。  
     * Transaction 狀態變為 🟡 處理中。  
     * 收到支付網關的成功回覆後，狀態更新為 🟢 已付款。  
     * 若收到失敗回覆，狀態則更新為 🔴 付款失敗，流程退回至步驟 2。  
4. **完成交易與關閉訂單:**  
   * **前提:** Transaction 狀態為 🟢 已付款。  
   * **系統反應:**  
     * 該桌關聯的 Order 狀態更新為 ✔️ 已完成 (Completed)。  
     * TableStatus 自動從 🟠 待付款 更新為 🔴 待清理，通知清潔人員。  
     * 系統生成一張電子 Receipt，並提供列印紙本收據的選項。  
5. **特殊流程：拆分帳單:**  
   * **動作:** 若顧客要求分開結帳，服務人員應在步驟 2 之前選擇「拆分帳單」功能。  
   * **規則:**  
     * **按人均分:** 系統將總金額除以指定人數，為每位顧客創建一筆獨立的 Transaction。  
     * **按項目拆分:** 服務人員可以將訂單中的項目分配給不同的子帳單，每一張子帳單都遵循步驟 2 至 4 的流程獨立結帳。  
   * **系統反應:** 只有當所有子帳單的 Transaction 狀態都為 🟢 已付款 時，整張 Order 才會被標記為 ✔️ 已完成。