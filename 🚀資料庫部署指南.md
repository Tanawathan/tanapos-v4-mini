# 🚀 TanaPOS v4 資料庫部署指南

**版本**: v4.0  
**日期**: 2025-08-05  

---

## 📋 部署檢查清單

### ✅ 部署前準備
- [ ] 確認 Supabase 專案已建立
- [ ] 取得資料庫連線資訊
- [ ] 備份現有資料（如有）
- [ ] 準備測試資料

### ✅ 部署步驟
1. [ ] 執行完整 SQL 架構
2. [ ] 驗證資料表建立
3. [ ] 載入初始資料
4. [ ] 設定權限與安全
5. [ ] 測試功能運作

---

## 🔧 部署方法

### 方法一：使用 Supabase Dashboard
1. 登入 Supabase Dashboard
2. 進入 SQL Editor
3. 複製 `supabase_complete.sql` 內容
4. 執行 SQL 腳本
5. 檢查執行結果

### 方法二：使用 psql 命令列
```bash
# 連線到 Supabase 資料庫
psql "postgresql://postgres:[YOUR-PASSWORD]@[YOUR-HOST]:5432/postgres"

# 執行 SQL 檔案
\i supabase_complete.sql

# 檢查資料表
\dt
```

### 方法三：使用 Supabase CLI
```bash
# 安裝 Supabase CLI
npm install -g supabase

# 初始化專案
supabase init

# 執行遷移
supabase db push
```

---

## 📊 部署驗證

### 1. 資料表檢查
```sql
-- 檢查資料表數量
SELECT COUNT(*) FROM information_schema.tables 
WHERE table_schema = 'public';

-- 應該顯示 35+ 個資料表
```

### 2. 索引檢查
```sql
-- 檢查索引
SELECT schemaname, tablename, indexname 
FROM pg_indexes 
WHERE schemaname = 'public'
ORDER BY tablename;
```

### 3. 觸發器檢查
```sql
-- 檢查觸發器
SELECT trigger_name, event_object_table 
FROM information_schema.triggers 
WHERE trigger_schema = 'public';
```

### 4. 測試資料驗證
```sql
-- 檢查初始資料
SELECT * FROM restaurants WHERE id = '11111111-1111-1111-1111-111111111111';
SELECT COUNT(*) FROM categories;
```

---

## 🔑 環境變數設定

更新你的 `.env` 檔案：

```env
# Supabase 設定
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key

# 資料庫設定
DATABASE_URL=postgresql://postgres:password@host:5432/postgres

# 測試餐廳 ID
VITE_TEST_RESTAURANT_ID=11111111-1111-1111-1111-111111111111
```

---

## 🧪 功能測試

### 1. 基礎 API 測試
```javascript
// 測試分類載入
const { data: categories } = await supabase
  .from('categories')
  .select('*')
  .eq('restaurant_id', '11111111-1111-1111-1111-111111111111');

console.log('分類數量:', categories?.length);

// 測試商品載入
const { data: products } = await supabase
  .from('products')
  .select('*, category:categories(*)')
  .eq('restaurant_id', '11111111-1111-1111-1111-111111111111');

console.log('商品數量:', products?.length);
```

### 2. 關聯查詢測試
```sql
-- 測試訂單關聯查詢
SELECT o.order_number, oi.product_name, t.table_number
FROM orders o
JOIN order_items oi ON o.id = oi.order_id
JOIN tables t ON o.table_id = t.id
LIMIT 5;
```

### 3. 即時功能測試
```javascript
// 測試即時訂閱
const subscription = supabase
  .channel('orders')
  .on('postgres_changes', { 
    event: 'INSERT', 
    schema: 'public', 
    table: 'orders' 
  }, (payload) => {
    console.log('新訂單:', payload.new);
  })
  .subscribe();
```

---

## 🔒 安全性設定

### 1. RLS 政策設定
```sql
-- 餐廳資料隔離
CREATE POLICY "餐廳資料隔離" ON restaurants 
FOR ALL USING (auth.jwt() ->> 'restaurant_id' = id::text);

-- 訂單存取控制
CREATE POLICY "訂單存取控制" ON orders 
FOR ALL USING (auth.jwt() ->> 'restaurant_id' = restaurant_id::text);
```

### 2. 角色權限設定
```sql
-- 建立角色
CREATE ROLE pos_user;
CREATE ROLE pos_admin;
CREATE ROLE pos_kitchen;

-- 設定權限
GRANT SELECT, INSERT, UPDATE ON orders TO pos_user;
GRANT ALL ON ALL TABLES IN SCHEMA public TO pos_admin;
GRANT SELECT, UPDATE ON order_items TO pos_kitchen;
```

---

## 📈 效能調整

### 1. 連線池設定
```javascript
// Supabase 客戶端設定
const supabase = createClient(supabaseUrl, supabaseKey, {
  db: {
    schema: 'public',
  },
  auth: {
    persistSession: true,
  },
  realtime: {
    params: {
      eventsPerSecond: 10,
    },
  },
});
```

### 2. 查詢優化設定
```sql
-- 設定查詢計劃快取
SET shared_preload_libraries = 'pg_stat_statements';

-- 設定記憶體參數
SET work_mem = '256MB';
SET shared_buffers = '512MB';
```

---

## 🚨 故障排除

### 常見問題

#### 1. 資料表建立失敗
**症狀**: SQL 執行錯誤  
**解決**: 檢查權限，確認以 postgres 使用者執行

#### 2. 索引建立失敗
**症狀**: 索引重複錯誤  
**解決**: 刪除現有索引後重新建立

#### 3. 觸發器無法執行
**症狀**: 函數不存在錯誤  
**解決**: 確認函數已正確建立

#### 4. RLS 政策阻擋查詢
**症狀**: 查詢返回空結果  
**解決**: 暫時停用 RLS 或調整政策

### 偵錯指令
```sql
-- 檢查連線狀態
SELECT * FROM pg_stat_activity;

-- 檢查鎖定狀況
SELECT * FROM pg_locks;

-- 檢查慢查詢
SELECT query, calls, total_time 
FROM pg_stat_statements 
ORDER BY total_time DESC;
```

---

## 📞 支援資源

### 文件連結
- [Supabase 文件](https://supabase.com/docs)
- [PostgreSQL 文件](https://www.postgresql.org/docs/)
- [RLS 設定指南](https://supabase.com/docs/guides/auth/row-level-security)

### 社群支援
- [Supabase Discord](https://discord.supabase.com/)
- [PostgreSQL 社群](https://www.postgresql.org/community/)

---

## ✅ 部署完成確認

完成部署後，請確認以下項目：

- [ ] ✅ 所有資料表已建立
- [ ] ✅ 索引運作正常
- [ ] ✅ 觸發器功能正常
- [ ] ✅ 初始資料已載入
- [ ] ✅ 權限設定正確
- [ ] ✅ 即時功能運作
- [ ] ✅ 前端連線成功
- [ ] ✅ 基礎功能測試通過

---

**部署完成！🎉**

你的 TanaPOS v4 AI 資料庫現在已經準備好支援完整的餐廳管理功能了。
