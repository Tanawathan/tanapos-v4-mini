# 🚀 TanaPOS V4-AI 預約系統資料庫設定指南

## 📋 當前狀態
✅ 環境變數設定完成 (Supabase API Key 已配置)  
✅ 桌台資料已存在 (5個桌台)  
❌ 需要執行 SQL 設定 (reservation_settings 欄位和 restaurant_holidays 表)

## 🎯 立即執行步驟

### 步驟 1: 開啟 Supabase 儀表板
1. 前往: https://supabase.com/dashboard
2. 選擇你的專案: `arksfwmcmwnyxvlcpskm`
3. 點擊左側選單的 "SQL Editor"

### 步驟 2: 執行 SQL 設定
1. 在 SQL 編輯器中，複製並執行 `manual-sql-setup.sql` 文件的內容
2. 或者逐一執行以下 SQL 命令：

#### 命令 1: 添加預約設定欄位
```sql
ALTER TABLE public.restaurants 
ADD COLUMN IF NOT EXISTS reservation_settings JSONB DEFAULT '{
    "businessHours": {
        "monday": {"isOpen": true, "openTime": "14:00", "closeTime": "21:00"},
        "tuesday": {"isOpen": true, "openTime": "14:00", "closeTime": "21:00"},
        "wednesday": {"isOpen": true, "openTime": "14:00", "closeTime": "21:00"},
        "thursday": {"isOpen": true, "openTime": "14:00", "closeTime": "21:00"},
        "friday": {"isOpen": true, "openTime": "14:00", "closeTime": "21:00"},
        "saturday": {"isOpen": true, "openTime": "14:00", "closeTime": "21:00"},
        "sunday": {"isOpen": true, "openTime": "14:00", "closeTime": "21:00"}
    },
    "reservationSettings": {
        "slotDurationMinutes": 30,
        "maxAdvanceBookingDays": 30,
        "minAdvanceBookingHours": 2,
        "mealDurationMinutes": 90,
        "lastReservationTime": "19:30"
    },
    "autoAssignment": {
        "enabled": true,
        "preferenceWeight": 0.3,
        "capacityWeight": 0.5,
        "aiPriorityWeight": 0.2
    }
}'::jsonb;
```

#### 命令 2: 創建假期表
```sql
CREATE TABLE IF NOT EXISTS public.restaurant_holidays (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    restaurant_id UUID NOT NULL REFERENCES public.restaurants(id) ON DELETE CASCADE,
    holiday_date DATE NOT NULL,
    holiday_name VARCHAR(255) NOT NULL,
    is_recurring BOOLEAN DEFAULT FALSE,
    recurrence_type VARCHAR(20) CHECK (recurrence_type IN ('yearly', 'monthly', 'weekly')) DEFAULT NULL,
    is_closed BOOLEAN DEFAULT TRUE,
    special_hours JSONB DEFAULT NULL,
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(restaurant_id, holiday_date)
);
```

#### 命令 3: 創建索引
```sql
CREATE INDEX IF NOT EXISTS idx_restaurant_holidays_restaurant_date 
ON public.restaurant_holidays(restaurant_id, holiday_date);

CREATE INDEX IF NOT EXISTS idx_restaurant_holidays_date_range 
ON public.restaurant_holidays(holiday_date);
```

#### 命令 4: 設定 RLS
```sql
ALTER TABLE public.restaurant_holidays ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Users can view holidays for their restaurant" ON public.restaurant_holidays;
CREATE POLICY "Users can view holidays for their restaurant" 
ON public.restaurant_holidays FOR SELECT 
USING (restaurant_id IN (
    SELECT r.id FROM public.restaurants r 
    WHERE r.id = restaurant_holidays.restaurant_id
));

DROP POLICY IF EXISTS "Users can manage holidays for their restaurant" ON public.restaurant_holidays;
CREATE POLICY "Users can manage holidays for their restaurant" 
ON public.restaurant_holidays FOR ALL 
USING (restaurant_id IN (
    SELECT r.id FROM public.restaurants r 
    WHERE r.id = restaurant_holidays.restaurant_id
));
```

### 步驟 3: 驗證設定
執行驗證腳本確認設定成功：
```bash
node verify-reservation-setup.cjs
```

## 🎯 完成後功能
- ✅ 每日 14:00-21:00 營業時間
- ✅ 90分鐘用餐時長  
- ✅ 最晚 19:30 預約
- ✅ 假期管理日曆
- ✅ 自動桌台分配

## 📁 相關檔案
- `manual-sql-setup.sql` - 完整 SQL 設定腳本
- `verify-reservation-setup.cjs` - 驗證腳本
- `execute-sql-setup.cjs` - 自動執行腳本 (API 限制無法使用)

## 🚨 重要提醒
執行 SQL 後立即驗證，如果出現錯誤請檢查：
1. Supabase 專案是否正確
2. 是否有權限執行 DDL 命令
3. 是否已經存在相同名稱的表或欄位

---

**🎉 執行完成後，預約系統將完全可用！**
