# 📋 菜單管理頁面設計報告

## 🎯 概述

本設計報告詳細說明菜單管理頁面的設計架構、功能規劃與技術實現，基於 Supabase 數據庫的真實數據，提供完整的菜單管理、套餐建立與修改功能。

---

## 📊 數據庫結構分析

### 核心表單結構

#### 1. **categories** (分類表)
```sql
- id: uuid (主鍵)
- restaurant_id: uuid (餐廳ID)
- name: 分類名稱
- description: 分類描述
- sort_order: 排序順序
- color: 分類顏色 (預設: #3B82F6)
- icon: 分類圖示 (預設: 🍽️)
- is_active: 是否啟用
```

#### 2. **products** (商品表)
```sql
- id: uuid (主鍵)
- restaurant_id: uuid (餐廳ID)
- category_id: uuid (分類ID)
- name: 商品名稱
- description: 商品描述
- sku: 商品編號
- price: 售價
- cost: 成本
- image_url: 商品圖片
- sort_order: 排序順序
- is_available: 是否可售
- is_active: 是否啟用
- preparation_time: 準備時間
- ai_popularity_score: AI 人氣分數
- ai_recommended: AI 推薦
```

#### 3. **combo_products** (套餐表)
```sql
- id: uuid (主鍵)
- name: 套餐名稱
- description: 套餐描述
- price: 套餐價格
- combo_type: 套餐類型 ('fixed', 'selectable')
- is_available: 是否可售
- preparation_time: 準備時間
- category_id: 所屬分類
```

#### 4. **combo_selection_rules** (套餐選擇規則)
```sql
- id: uuid (主鍵)
- combo_id: 套餐ID
- category_id: 可選分類ID
- selection_name: 選擇項目名稱
- min_selections: 最少選擇數量
- max_selections: 最多選擇數量
- is_required: 是否必選
- display_order: 顯示順序
```

#### 5. **combo_selection_options** (套餐選擇選項)
```sql
- id: uuid (主鍵)
- rule_id: 規則ID
- product_id: 商品ID
- additional_price: 額外費用
- is_default: 是否預設選項
```

---

## 🎨 頁面設計架構

### 主要版面配置

```
┌─────────────────────────────────────────────────────────┐
│  [返回首頁]                               📋 菜單管理    │
├─────────────────────────────────────────────────────────┤
│ [📝 商品管理] [🎁 套餐管理] [📂 分類管理] [📊 報表分析]  │
├─────────────────────────────────────────────────────────┤
│                                                         │
│                   主要內容區域                           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Tab 導航結構

1. **📝 商品管理** - 單品菜單的 CRUD 操作
2. **🎁 套餐管理** - 套餐的建立、編輯與規則設定
3. **📂 分類管理** - 分類的管理與排序
4. **📊 報表分析** - 銷售數據與 AI 分析（後續開發）

---

## 🛠️ 功能模組設計

### 1. 商品管理模組

#### 1.1 商品列表視圖
```typescript
interface ProductListView {
  // 篩選功能
  filters: {
    category: string | null
    availability: 'all' | 'available' | 'unavailable'
    aiRecommended: boolean | null
    searchTerm: string
  }
  
  // 排序功能
  sorting: {
    field: 'name' | 'price' | 'popularity' | 'created_at'
    order: 'asc' | 'desc'
  }
  
  // 顯示模式
  viewMode: 'grid' | 'list' | 'table'
}
```

#### 1.2 商品卡片組件
```
┌─────────────────────────────┐
│ [📷 商品圖片]                │
│                            │
│ 🍜 商品名稱                 │
│ 💰 NT$ 120                 │
│ ⭐ 人氣: 85%               │
│                            │
│ [✏️編輯] [📋複製] [🗑️刪除] │
└─────────────────────────────┘
```

#### 1.3 商品編輯表單
```typescript
interface ProductForm {
  basic: {
    name: string
    description: string
    sku: string
    category_id: string
  }
  
  pricing: {
    price: number
    cost: number
  }
  
  availability: {
    is_available: boolean
    is_active: boolean
    preparation_time: number
  }
  
  media: {
    image_url: string
    image_file?: File
  }
  
  advanced: {
    sort_order: number
    ai_recommended: boolean
  }
}
```

### 2. 套餐管理模組

#### 2.1 套餐類型選擇
- **固定套餐 (Fixed Combo)**: 預設組合，不可更改
- **可選套餐 (Selectable Combo)**: 客戶可自由選擇組合

#### 2.2 套餐建立流程
```
步驟 1: 基本資訊
├── 套餐名稱
├── 套餐描述
├── 套餐價格
├── 套餐類型
└── 所屬分類

步驟 2: 選擇規則設定 (僅可選套餐)
├── 前菜選擇 (必選 1 項)
├── 主餐選擇 (必選 1 項)
├── 飲品選擇 (必選 1 項)
└── 甜點選擇 (必選 1 項)

步驟 3: 商品選項設定
├── 為每個規則添加可選商品
├── 設定額外費用
├── 設定預設選項
└── 排序與優化

步驟 4: 預覽與發布
├── 套餐預覽
├── 價格計算驗證
├── 規則邏輯檢查
└── 正式發布
```

#### 2.3 套餐規則編輯器
```
┌─────────────────────────────────────────────┐
│ 🎯 選擇規則: 主餐選擇                        │
├─────────────────────────────────────────────┤
│ 分類: [🍜 主食類 ▼]                        │
│ 選擇項目名稱: [主餐選擇____________]         │
│ 最少選擇: [1] 最多選擇: [1]                 │
│ □ 必選項目 ☑ 顯示在前面                    │
├─────────────────────────────────────────────┤
│ 🍜 可選商品:                               │
│ ☑ 牛肉拉麵 (+$0)                          │
│ ☑ 豚骨拉麵 (+$20)                         │
│ ☑ 海鮮拉麵 (+$50)                         │
│ □ 素食拉麵 (+$0)                          │
├─────────────────────────────────────────────┤
│ [💾 儲存規則] [❌ 取消] [🗑️ 刪除規則]      │
└─────────────────────────────────────────────┘
```

### 3. 分類管理模組

#### 3.1 分類列表
```
┌─────────────────────────────────────────────┐
│ 🍽️ 分類管理                              │
├─────────────────────────────────────────────┤
│ [+ 新增分類]                              │
├─────────────────────────────────────────────┤
│ 🍜 #3B82F6 主食類      [18 項商品] [↕️編輯] │
│ 🥤 #F59E0B 飲料類      [12 項商品] [↕️編輯] │
│ 🍰 #10B981 甜點類      [8 項商品]  [↕️編輯] │
│ 🥗 #EF4444 沙拉類      [6 項商品]  [↕️編輯] │
└─────────────────────────────────────────────┘
```

#### 3.2 分類編輯表單
```typescript
interface CategoryForm {
  name: string           // 分類名稱
  description: string    // 分類描述
  icon: string          // 圖示 emoji
  color: string         // 主題顏色
  sort_order: number    // 排序順序
  is_active: boolean    // 是否啟用
}
```

---

## 🔧 技術實現規劃

### 1. Supabase API 整合

#### 1.1 資料存取層 (Data Access Layer)
```typescript
// services/menuService.ts
export class MenuService {
  // 商品相關
  async getProducts(filters?: ProductFilters): Promise<Product[]>
  async getProductById(id: string): Promise<Product>
  async createProduct(product: CreateProductDto): Promise<Product>
  async updateProduct(id: string, product: UpdateProductDto): Promise<Product>
  async deleteProduct(id: string): Promise<void>
  
  // 分類相關
  async getCategories(): Promise<Category[]>
  async createCategory(category: CreateCategoryDto): Promise<Category>
  async updateCategory(id: string, category: UpdateCategoryDto): Promise<Category>
  async deleteCategory(id: string): Promise<void>
  
  // 套餐相關
  async getCombos(): Promise<Combo[]>
  async getComboById(id: string): Promise<ComboWithRules>
  async createCombo(combo: CreateComboDto): Promise<Combo>
  async updateCombo(id: string, combo: UpdateComboDto): Promise<Combo>
  async deleteCombo(id: string): Promise<void>
  
  // 套餐規則相關
  async getComboRules(comboId: string): Promise<ComboRule[]>
  async createComboRule(rule: CreateComboRuleDto): Promise<ComboRule>
  async updateComboRule(id: string, rule: UpdateComboRuleDto): Promise<ComboRule>
  async deleteComboRule(id: string): Promise<void>
}
```

#### 1.2 即時同步功能
```typescript
// hooks/useRealtimeMenu.ts
export function useRealtimeMenu() {
  const [products, setProducts] = useState<Product[]>([])
  const [categories, setCategories] = useState<Category[]>([])
  
  useEffect(() => {
    // 訂閱商品變更
    const productSubscription = supabase
      .channel('products')
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'products'
      }, handleProductChange)
      .subscribe()
    
    // 訂閱分類變更
    const categorySubscription = supabase
      .channel('categories')
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'categories'
      }, handleCategoryChange)
      .subscribe()
    
    return () => {
      productSubscription.unsubscribe()
      categorySubscription.unsubscribe()
    }
  }, [])
  
  return { products, categories, isLoading, error }
}
```

### 2. 狀態管理

#### 2.1 Menu Store (Zustand)
```typescript
// stores/menuStore.ts
interface MenuStore {
  // 狀態
  products: Product[]
  categories: Category[]
  combos: Combo[]
  loading: boolean
  error: string | null
  
  // 篩選與搜尋
  filters: ProductFilters
  searchTerm: string
  selectedCategory: string | null
  
  // 操作方法
  loadProducts: () => Promise<void>
  loadCategories: () => Promise<void>
  loadCombos: () => Promise<void>
  
  createProduct: (product: CreateProductDto) => Promise<void>
  updateProduct: (id: string, product: UpdateProductDto) => Promise<void>
  deleteProduct: (id: string) => Promise<void>
  
  setFilters: (filters: Partial<ProductFilters>) => void
  setSearchTerm: (term: string) => void
  setSelectedCategory: (categoryId: string | null) => void
}
```

### 3. 組件架構

#### 3.1 頁面組件結構
```
MenuManagementPage
├── MenuTabs
│   ├── ProductManagement
│   │   ├── ProductFilters
│   │   ├── ProductGrid
│   │   │   └── ProductCard
│   │   └── ProductModal
│   │       ├── BasicInfoForm
│   │       ├── PricingForm
│   │       ├── AvailabilityForm
│   │       └── MediaUploadForm
│   │
│   ├── ComboManagement
│   │   ├── ComboList
│   │   │   └── ComboCard
│   │   └── ComboEditor
│   │       ├── BasicInfoStep
│   │       ├── RulesStep
│   │       │   └── RuleEditor
│   │       ├── OptionsStep
│   │       │   └── OptionSelector
│   │       └── PreviewStep
│   │
│   ├── CategoryManagement
│   │   ├── CategoryList
│   │   │   └── CategoryItem
│   │   └── CategoryModal
│   │
│   └── Analytics
│       ├── SalesChart
│       ├── PopularityRanking
│       └── AIRecommendations
```

---

## 🎯 用戶體驗設計

### 1. 響應式設計

#### 1.1 斷點規劃
- **Mobile**: < 768px - 單欄顯示，摺疊選單
- **Tablet**: 768px - 1024px - 雙欄顯示，側邊選單
- **Desktop**: > 1024px - 多欄顯示，完整功能

#### 1.2 互動設計
```typescript
// 拖拽排序
interface DragDropItem {
  id: string
  type: 'product' | 'category' | 'combo'
  sortOrder: number
}

// 批量操作
interface BatchOperation {
  selectedItems: string[]
  operation: 'delete' | 'activate' | 'deactivate' | 'category_change'
  confirm: boolean
}
```

### 2. 無障礙設計 (A11y)

```typescript
// 鍵盤導航支援
const keyboardNavigation = {
  Tab: '在表單欄位間移動',
  'Ctrl + S': '快速儲存',
  'Ctrl + N': '新增項目',
  Escape: '關閉模態框',
  'Arrow Keys': '在網格中導航'
}

// ARIA 標籤
const ariaLabels = {
  productGrid: 'aria-label="商品網格"',
  productCard: 'aria-labelledby="product-name" aria-describedby="product-description"',
  actionButton: 'aria-label="編輯商品" role="button"'
}
```

---

## 📱 功能特色

### 1. 智能功能（後續開發）

#### 1.1 AI 輔助建議
- **商品定價建議**: 基於成本與市場分析
- **套餐組合推薦**: 基於銷售數據的最佳組合
- **分類優化建議**: 根據客戶行為優化分類排序

#### 1.2 自動化功能
- **庫存警示**: 商品庫存不足自動提醒
- **價格同步**: 成本變動時自動建議調價
- **熱門商品標記**: 自動標記熱銷商品

### 2. 進階功能（後續開發）

#### 2.1 批量操作
```typescript
interface BatchOperations {
  selectAll: () => void
  selectCategory: (categoryId: string) => void
  bulkEdit: (changes: Partial<Product>) => Promise<void>
  bulkDelete: (ids: string[]) => Promise<void>
  bulkStatusChange: (ids: string[], status: boolean) => Promise<void>
}
```

#### 2.2 匯入匯出
```typescript
interface ImportExport {
  exportProducts: (format: 'csv' | 'xlsx' | 'json') => Promise<Blob>
  importProducts: (file: File) => Promise<ImportResult>
  exportMenu: () => Promise<MenuExport>
  importMenu: (data: MenuImport) => Promise<ImportResult>
}
```

---

## 🚀 實作階段規劃

### ✅ Phase 1: 基礎架構 (已完成)
- [x] 資料庫架構分析
- [x] Supabase 連接設定  
- [x] TypeScript 類型定義
- [x] 菜單服務層建立
- [x] Zustand 狀態管理
- [x] 基礎組件開發
- [x] 路由與導航整合
- [x] 主頁面導航卡片

**Phase 1 完成報告 (2024-12-19)**:
- ✅ 完成 `menu-types.ts` - 完整的菜單管理類型定義
- ✅ 完成 `menuService.ts` - Supabase API 整合服務層  
- ✅ 完成 `menuStore.ts` - Zustand 狀態管理與操作邏輯
- ✅ 完成 `MenuManagementPage.tsx` - 主要菜單管理頁面框架
- ✅ 完成 `App.tsx` 路由整合 - 添加菜單管理路由與導航
- ✅ 主頁面新增菜單管理導航卡片，使用 emerald 色系

### ✅ Phase 2: 商品管理 (已完成)
- [x] 商品列表與篩選界面
- [x] 商品卡片組件設計
- [x] 商品網格與列表檢視
- [x] 篩選與搜尋功能
- [x] 排序與檢視模式切換
- [x] 批量選取功能
- [x] 響應式設計實現

**Phase 2 完成報告 (2024-12-19)**:
- ✅ 完成 `ProductCard.tsx` - 商品卡片展示組件
- ✅ 完成 `ProductFilters.tsx` - 商品篩選與搜尋界面
- ✅ 完成 `ProductGrid.tsx` - 商品網格展示與管理
- ✅ 完成 `ProductManagement.tsx` - 商品管理主控制器
- ✅ 更新 `MenuManagementPage.tsx` - 整合商品管理模組
- ✅ 實現完整的商品展示、篩選、排序功能
- ✅ 支援網格與列表兩種檢視模式
- ✅ 響應式設計與無障礙功能支援

### ✅ Phase 3: 分類管理 (已完成)
- [x] 分類 CRUD 功能
- [x] 分類排序與拖拽
- [x] 顏色與圖示選擇器
- [x] 分類商品統計
- [x] 搜尋與篩選功能
- [x] 智能刪除保護
- [x] 即時預覽功能

**Phase 3 完成報告 (2024-12-19)**:
- ✅ 完成 `CategoryCard.tsx` - 分類卡片展示組件
- ✅ 完成 `CategoryModal.tsx` - 分類編輯模態框
- ✅ 完成 `CategoryManagement.tsx` - 分類管理主控制器
- ✅ 整合到 `MenuManagementPage.tsx` - 完整的 Tab 導航
- ✅ 實現完整的分類 CRUD 操作功能
- ✅ 30+ 圖示選擇器 + 無限色彩自訂
- ✅ 智能排序與業務邏輯保護
- ✅ 搜尋、統計、即時預覽功能

### ✅ Phase 4: 套餐管理 (已完成基礎功能)
- ✅ 套餐基礎功能 (ComboCard, ComboModal, ComboManagement)
- ✅ 套餐 CRUD 操作
- ✅ 套餐類型支援 (固定套餐/自選套餐)
- ✅ 統計儀表板與篩選系統
- [ ] 規則編輯器 (待開發)
- [ ] 選項設定介面 (待開發)
- [ ] 預覽與驗證 (待開發)

**Phase 4 基礎功能完成報告 (2025-08-05)**:
- ✅ 實現了完整的套餐管理基礎架構
- ✅ 包含 ComboCard、ComboModal、ComboManagement 三大核心組件
- ✅ 支援套餐類型設定與供應狀態管理
- ✅ 提供多維度篩選與搜尋功能
- ✅ 整合統計儀表板與響應式設計

### Phase 5: 進階功能 (Week 9-10)
- [ ] 即時同步
- [ ] 批量操作
- [ ] 匯入匯出
- [ ] AI 功能整合

### Phase 6: 優化與測試 (Week 11-12)
- [ ] 效能優化
- [ ] 使用者測試
- [ ] 錯誤處理
- [ ] 文檔完善

---

## 🔒 安全性考量

### 1. 資料驗證
```typescript
// 前端驗證
const productValidation = z.object({
  name: z.string().min(1, '商品名稱不能為空').max(100, '商品名稱過長'),
  price: z.number().min(0, '價格不能為負數').max(999999, '價格過高'),
  sku: z.string().optional().refine(validateSKU, 'SKU 格式錯誤')
})

// 後端 RLS 政策
CREATE POLICY "Users can only access their restaurant's menu"
ON products FOR ALL
TO authenticated
USING (restaurant_id = auth.jwt() ->> 'restaurant_id');
```

### 2. 權限控制
```typescript
interface UserPermissions {
  canViewMenu: boolean
  canEditProducts: boolean
  canCreateCombos: boolean
  canDeleteItems: boolean
  canManageCategories: boolean
  canAccessAnalytics: boolean
}
```

---

## 📊 效能優化

### 1. 資料載入優化
```typescript
// 分頁載入
const useInfiniteProducts = () => {
  return useInfiniteQuery({
    queryKey: ['products', filters],
    queryFn: ({ pageParam = 0 }) => 
      menuService.getProducts({ ...filters, page: pageParam }),
    getNextPageParam: (lastPage) => lastPage.nextPage
  })
}

// 快取策略
const cacheConfig = {
  staleTime: 5 * 60 * 1000,     // 5 分鐘
  cacheTime: 10 * 60 * 1000,    // 10 分鐘
  refetchOnWindowFocus: false
}
```

### 2. 圖片優化
```typescript
// 圖片壓縮與 CDN
const imageOptimization = {
  compress: true,
  maxWidth: 800,
  maxHeight: 600,
  quality: 0.8,
  format: 'webp',
  cdn: 'supabase-storage'
}
```

---

## 📋 測試策略

### 1. 單元測試
```typescript
// services/menuService.test.ts
describe('MenuService', () => {
  test('should create product successfully', async () => {
    const product = await menuService.createProduct(mockProductData)
    expect(product).toHaveProperty('id')
    expect(product.name).toBe(mockProductData.name)
  })
})
```

### 2. 整合測試
```typescript
// integration/menu-workflow.test.ts
describe('Menu Management Workflow', () => {
  test('should complete full product lifecycle', async () => {
    // 建立 -> 編輯 -> 刪除流程測試
  })
})
```

### 3. E2E 測試
```typescript
// e2e/menu-management.spec.ts
test('should manage products end-to-end', async ({ page }) => {
  await page.goto('/menu-management')
  await page.click('[data-testid="add-product"]')
  await page.fill('[data-testid="product-name"]', 'Test Product')
  await page.click('[data-testid="save-product"]')
  await expect(page.locator('[data-testid="product-list"]')).toContainText('Test Product')
})
```

---

## 🎨 設計系統

### 1. 色彩系統
```css
:root {
  /* 主要色彩 */
  --menu-primary: #3B82F6;
  --menu-secondary: #10B981;
  --menu-accent: #F59E0B;
  
  /* 狀態色彩 */
  --menu-success: #22C55E;
  --menu-warning: #F59E0B;
  --menu-error: #EF4444;
  --menu-info: #3B82F6;
  
  /* 分類預設色彩 */
  --category-colors: #3B82F6, #10B981, #F59E0B, #EF4444, #8B5CF6;
}
```

### 2. 組件樣式
```typescript
// 統一的卡片樣式
const cardStyles = {
  base: 'bg-white rounded-lg shadow-sm border border-gray-200',
  hover: 'hover:shadow-md transition-shadow duration-200',
  selected: 'ring-2 ring-blue-500 ring-opacity-50'
}

// 按鈕樣式系統
const buttonVariants = {
  primary: 'bg-blue-600 text-white hover:bg-blue-700',
  secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300',
  danger: 'bg-red-600 text-white hover:bg-red-700',
  ghost: 'text-gray-600 hover:bg-gray-100'
}
```

---

## 📈 成功指標

### 1. 技術指標
- **載入時間**: < 2 秒
- **響應時間**: < 500ms
- **錯誤率**: < 1%
- **可用性**: > 99.9%

### 2. 使用者體驗指標
- **任務完成率**: > 95%
- **學習曲線**: < 30 分鐘上手
- **滿意度評分**: > 4.5/5
- **錯誤恢復**: < 10 秒

### 3. 業務指標
- **菜單更新頻率**: 提升 200%
- **套餐建立效率**: 提升 300%
- **管理時間節省**: 50%
- **資料準確性**: > 98%

---

## 🔮 未來擴展

### 1. 進階功能
- **多語言菜單**: 支援多國語言
- **營養標示**: 自動計算營養成分
- **過敏原標記**: 過敏原警示系統
- **季節性菜單**: 時間限定商品

### 2. AI 智能化
- **動態定價**: AI 自動調整價格
- **需求預測**: 預測商品需求量
- **個人化推薦**: 為客戶推薦套餐
- **趨勢分析**: 市場趨勢分析

### 3. 整合功能
- **供應商整合**: 直接向供應商下單
- **成本分析**: 即時成本計算
- **利潤追蹤**: 獲利分析報告
- **競爭分析**: 市場價格比較

---

## 📝 結論

本菜單管理頁面設計提供了完整的商品管理、套餐建立與分類管理功能，基於 Supabase 的強大後端支援，配合現代化的前端技術，將為餐廳經營者提供高效、直觀的菜單管理體驗。

透過階段性的開發規劃與嚴格的測試策略，確保系統的穩定性與可用性，同時為未來的功能擴展預留了充足的空間。

**預計完成時間**: 12 週  
**開發資源**: 2-3 名前端工程師 + 1 名 UI/UX 設計師  
**技術棧**: React + TypeScript + Zustand + Supabase + Tailwind CSS

---

*© 2024 TanaPOS v4 AI - 菜單管理系統設計文檔*
