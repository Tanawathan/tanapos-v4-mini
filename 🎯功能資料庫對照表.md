# 🎯 TanaPOS v4 功能與資料庫對照表

**版本**: v4.0  
**日期**: 2025-08-05  
**描述**: 詳細列出每個功能頁面所需的資料庫資源

---

## 📋 功能頁面資料需求對照

### 1. 🍽️ 點餐系統 (OrderingPage.tsx)

#### 核心功能
- ✅ 商品分類瀏覽
- ✅ 商品展示與篩選
- ✅ 購物車管理
- ✅ 套餐選擇
- ✅ 桌台選擇
- ✅ 訂單提交

#### 資料表需求

| 資料表 | 用途 | 關鍵欄位 | 查詢頻率 |
|--------|------|----------|----------|
| `categories` | 分類列表顯示 | `id`, `name`, `icon`, `color`, `sort_order` | 高 |
| `products` | 商品展示 | `id`, `name`, `price`, `description`, `image_url`, `is_available` | 高 |
| `product_variants` | 商品規格選擇 | `id`, `product_id`, `name`, `price_adjustment` | 中 |
| `product_modifiers` | 加料選項 | `id`, `product_id`, `name`, `price`, `type` | 中 |
| `combo_products` | 套餐列表 | `id`, `name`, `price`, `description`, `combo_type` | 中 |
| `combo_selection_rules` | 套餐規則 | `id`, `combo_id`, `selection_name`, `min_selections`, `max_selections` | 中 |
| `combo_selection_options` | 套餐選項 | `id`, `rule_id`, `product_id`, `additional_price` | 中 |
| `tables` | 桌台選擇 | `id`, `table_number`, `name`, `status`, `capacity` | 低 |

#### API 查詢需求
```sql
-- 載入分類
SELECT id, name, icon, color, sort_order 
FROM categories 
WHERE restaurant_id = ? AND is_active = true 
ORDER BY sort_order;

-- 載入商品（含分類篩選）
SELECT p.*, c.name as category_name 
FROM products p 
LEFT JOIN categories c ON p.category_id = c.id 
WHERE p.restaurant_id = ? AND p.is_available = true 
AND (? IS NULL OR p.category_id = ?)
ORDER BY p.sort_order;

-- 載入套餐與規則
SELECT cp.*, csr.*, cso.* 
FROM combo_products cp 
LEFT JOIN combo_selection_rules csr ON cp.id = csr.combo_id 
LEFT JOIN combo_selection_options cso ON csr.id = cso.rule_id 
WHERE cp.is_available = true;
```

---

### 2. 📋 訂單管理 (OrdersPage.tsx)

#### 核心功能
- ✅ 訂單列表顯示
- ✅ 訂單狀態篩選
- ✅ 訂單詳情查看
- ✅ 訂單狀態更新
- ✅ 時間範圍篩選

#### 資料表需求

| 資料表 | 用途 | 關鍵欄位 | 查詢頻率 |
|--------|------|----------|----------|
| `orders` | 訂單主資料 | `id`, `order_number`, `table_number`, `status`, `total_amount`, `created_at` | 高 |
| `order_items` | 訂單項目 | `id`, `order_id`, `product_name`, `quantity`, `unit_price`, `status` | 高 |
| `tables` | 桌台資訊 | `id`, `table_number`, `name` | 中 |
| `products` | 商品詳情 | `id`, `name`, `image_url` | 中 |
| `payments` | 付款狀態 | `id`, `order_id`, `status`, `amount` | 低 |

#### API 查詢需求
```sql
-- 訂單列表（含篩選）
SELECT o.*, t.table_number, t.name as table_name,
       COUNT(oi.id) as item_count,
       SUM(oi.quantity) as total_quantity
FROM orders o 
LEFT JOIN tables t ON o.table_id = t.id 
LEFT JOIN order_items oi ON o.id = oi.order_id 
WHERE o.restaurant_id = ? 
AND (? IS NULL OR o.status = ?)
AND (? IS NULL OR DATE(o.created_at) >= ?)
GROUP BY o.id 
ORDER BY o.created_at DESC;

-- 訂單詳情
SELECT oi.*, p.image_url 
FROM order_items oi 
LEFT JOIN products p ON oi.product_id = p.id 
WHERE oi.order_id = ?;
```

---

### 3. 🪑 桌台管理 (TableManagementPage.tsx)

#### 核心功能
- ✅ 桌台狀態總覽
- ✅ 桌台狀態切換
- ✅ 桌台預約管理
- ✅ 清潔與維護狀態
- ✅ 桌台使用會話

#### 資料表需求

| 資料表 | 用途 | 關鍵欄位 | 查詢頻率 |
|--------|------|----------|----------|
| `tables` | 桌台主資料 | `id`, `table_number`, `status`, `capacity`, `current_session_id` | 高 |
| `table_sessions` | 使用會話 | `id`, `table_id`, `customer_name`, `party_size`, `seated_at` | 高 |
| `table_reservations` | 預約資料 | `id`, `table_id`, `customer_name`, `reservation_time`, `status` | 中 |
| `orders` | 相關訂單 | `id`, `table_id`, `order_number`, `status`, `total_amount` | 中 |
| `order_items` | 訂單項目 | `id`, `order_id`, `product_name`, `quantity` | 低 |

#### API 查詢需求
```sql
-- 桌台總覽
SELECT t.*, ts.customer_name, ts.party_size, ts.seated_at,
       o.order_number, o.total_amount, o.status as order_status
FROM tables t 
LEFT JOIN table_sessions ts ON t.current_session_id = ts.id 
LEFT JOIN orders o ON t.id = o.table_id AND o.status IN ('pending', 'confirmed', 'preparing')
WHERE t.restaurant_id = ? AND t.is_active = true;

-- 桌台預約
SELECT * FROM table_reservations 
WHERE table_id = ? AND reservation_time >= CURRENT_DATE 
ORDER BY reservation_time;
```

---

### 4. 💳 結帳系統 (CheckoutPage.tsx)

#### 核心功能
- ✅ 選擇結帳桌台
- ✅ 查看訂單明細
- ✅ 付款方式選擇
- ✅ 金額計算
- ✅ 收據生成

#### 資料表需求

| 資料表 | 用途 | 關鍵欄位 | 查詢頻率 |
|--------|------|----------|----------|
| `orders` | 待結帳訂單 | `id`, `order_number`, `table_id`, `subtotal`, `total_amount`, `status` | 高 |
| `order_items` | 訂單明細 | `id`, `order_id`, `product_name`, `quantity`, `unit_price`, `total_price` | 高 |
| `tables` | 桌台資訊 | `id`, `table_number`, `name`, `status` | 中 |
| `payments` | 付款記錄 | `id`, `order_id`, `payment_method`, `amount`, `status` | 中 |
| `receipts` | 收據記錄 | `id`, `order_id`, `receipt_number`, `total_amount` | 低 |

#### API 查詢需求
```sql
-- 待結帳桌台
SELECT t.*, o.id as order_id, o.order_number, o.total_amount 
FROM tables t 
JOIN orders o ON t.id = o.table_id 
WHERE o.status IN ('served', 'ready') AND o.payment_status = 'unpaid';

-- 結帳明細
SELECT oi.product_name, oi.quantity, oi.unit_price, oi.total_price 
FROM order_items oi 
WHERE oi.order_id = ?;
```

---

### 5. 📂 菜單管理系統

#### 核心功能
- ✅ 分類管理 (CRUD)
- ✅ 商品管理 (CRUD)
- ✅ 套餐管理 (CRUD)
- ✅ 批量操作
- ✅ 排序與搜尋

#### 資料表需求

| 資料表 | 用途 | 關鍵欄位 | 查詢頻率 |
|--------|------|----------|----------|
| `categories` | 分類管理 | 所有欄位 | 高 |
| `products` | 商品管理 | 所有欄位 | 高 |
| `product_variants` | 商品變體 | 所有欄位 | 中 |
| `product_modifiers` | 商品加料 | 所有欄位 | 中 |
| `combo_products` | 套餐管理 | 所有欄位 | 中 |
| `combo_selection_rules` | 套餐規則 | 所有欄位 | 中 |
| `combo_selection_options` | 套餐選項 | 所有欄位 | 中 |

---

### 6. 🍳 KDS 廚房顯示系統

#### 核心功能
- ✅ 待製作項目顯示
- ✅ 製作狀態更新
- ✅ 時間管理
- ✅ 品質檢查
- ✅ 完成通知

#### 資料表需求

| 資料表 | 用途 | 關鍵欄位 | 查詢頻率 |
|--------|------|----------|----------|
| `orders` | 訂單狀態 | `id`, `order_number`, `table_number`, `status`, `created_at` | 高 |
| `order_items` | 製作項目 | `id`, `product_name`, `quantity`, `status`, `special_instructions` | 高 |
| `products` | 製作時間 | `id`, `prep_time_minutes`, `kitchen_station` | 中 |
| `tables` | 桌台資訊 | `id`, `table_number` | 低 |

#### API 查詢需求
```sql
-- KDS 待製作項目
SELECT o.order_number, o.table_number, oi.product_name, oi.quantity, 
       oi.status, oi.special_instructions, p.prep_time_minutes,
       oi.created_at, oi.preparation_started_at
FROM order_items oi 
JOIN orders o ON oi.order_id = o.id 
LEFT JOIN products p ON oi.product_id = p.id 
WHERE oi.status IN ('confirmed', 'preparing') 
ORDER BY oi.created_at;
```

---

## 🔄 資料同步需求

### 即時更新需求

| 功能 | 觸發事件 | 影響頁面 | 同步資料 |
|------|----------|----------|----------|
| 新訂單 | 訂單提交 | KDS, 訂單管理, 桌台管理 | `orders`, `order_items`, `tables` |
| 狀態更新 | KDS 操作 | 訂單管理, 桌台管理 | `order_items.status` |
| 桌台狀態 | 桌台操作 | 桌台管理, 點餐系統 | `tables.status` |
| 結帳完成 | 付款處理 | 桌台管理, 訂單管理 | `orders`, `payments`, `tables` |

### Supabase Realtime 設定
```sql
-- 啟用即時訂閱的資料表
ALTER PUBLICATION supabase_realtime ADD TABLE orders;
ALTER PUBLICATION supabase_realtime ADD TABLE order_items;
ALTER PUBLICATION supabase_realtime ADD TABLE tables;
```

---

## 📊 效能優化建議

### 1. 查詢優化
```sql
-- 點餐系統常用查詢優化
CREATE INDEX idx_products_category_available 
ON products(category_id, is_available, sort_order);

-- 訂單管理查詢優化
CREATE INDEX idx_orders_restaurant_status_date 
ON orders(restaurant_id, status, created_at DESC);

-- KDS 系統查詢優化
CREATE INDEX idx_order_items_status_created 
ON order_items(status, created_at);
```

### 2. 快取策略
- **分類與商品**: 快取 1 小時，異動時清除
- **桌台狀態**: 快取 5 分鐘
- **訂單列表**: 不快取，使用即時查詢

### 3. 分頁查詢
```sql
-- 訂單分頁查詢
SELECT * FROM orders 
WHERE restaurant_id = ? 
ORDER BY created_at DESC 
LIMIT ? OFFSET ?;
```

---

## 🚨 注意事項

### 1. 資料一致性
- 訂單狀態更新需要事務處理
- 桌台狀態變更需要驗證
- 庫存扣減需要樂觀鎖定

### 2. 併發處理
- 同時點餐的競態條件
- 桌台狀態衝突處理
- 付款重複提交防護

### 3. 資料驗證
- 訂單金額計算驗證
- 桌台容量限制檢查
- 商品可用性檢查

---

## 📈 擴展規劃

### 短期擴展 (1-3 個月)
- [ ] 會員系統整合
- [ ] 優惠券功能
- [ ] 外送系統
- [ ] 行動支付

### 中期擴展 (3-6 個月)
- [ ] 多店管理
- [ ] 供應鏈管理
- [ ] 財務報表
- [ ] CRM 系統

### 長期擴展 (6-12 個月)
- [ ] AI 推薦引擎
- [ ] 預測分析
- [ ] 自動排程
- [ ] IoT 設備整合

---

*此對照表確保每個功能頁面都有完整的資料支援，並預留未來擴展空間。*
