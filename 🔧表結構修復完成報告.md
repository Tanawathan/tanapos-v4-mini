# ğŸ”§ è¡¨çµæ§‹ä¿®å¾©å®Œæˆå ±å‘Š

## ğŸ“… ä¿®å¾©æ—¥æœŸ
2025å¹´8æœˆ5æ—¥

## ğŸš¨ ç™¼ç¾çš„å•é¡Œ
åœ¨æ¸¬è©¦æ¡Œä½ç®¡ç†åŠŸèƒ½æ™‚ç™¼ç¾éŒ¯èª¤ï¼š
```
æ›´æ–°æ¡Œå°å¤±æ•—: Could not find the 'current_order_id' column of 'tables' in the schema cache
```

## ğŸ” æ ¹æœ¬åŸå› 
ç¨‹å¼ç¢¼ä¸­ä½¿ç”¨çš„æ¡Œå°è¡¨æ¬„ä½èˆ‡å¯¦éš› Supabase è³‡æ–™åº«è¡¨çµæ§‹ä¸åŒ¹é…ã€‚

## ğŸ“Š çœŸå¯¦çš„è¡¨çµæ§‹åˆ†æ

### Tables è¡¨å¯¦éš›çµæ§‹
æ ¹æ“š `supabase_complete.sql` æ–‡ä»¶ï¼Œ`tables` è¡¨çš„çœŸå¯¦çµæ§‹ç‚ºï¼š

```sql
CREATE TABLE public.tables (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  restaurant_id uuid NOT NULL,
  table_number integer NOT NULL,
  name character varying(100),
  capacity integer DEFAULT 4,
  min_capacity integer DEFAULT 1,
  max_capacity integer,
  
  -- ç‹€æ…‹ç®¡ç†
  status character varying(50) DEFAULT 'available',
  
  -- ä½ç½®è³‡è¨Š
  floor_level integer DEFAULT 1,
  zone character varying(100),
  position_x numeric(8,2) DEFAULT 0,
  position_y numeric(8,2) DEFAULT 0,
  
  -- æ¡Œå°å±¬æ€§
  table_type character varying(50) DEFAULT 'square',
  features jsonb,
  
  -- QR Code é»é¤
  qr_code text,
  qr_enabled boolean DEFAULT true,
  
  -- æ™ºèƒ½åˆ†é…
  ai_assignment_priority integer DEFAULT 5,
  ai_features_score jsonb,
  
  -- ç‹€æ…‹è¿½è¹¤
  current_session_id uuid,          -- âœ… å­˜åœ¨
  last_occupied_at timestamp,       -- âœ… å­˜åœ¨
  last_cleaned_at timestamp,        -- âœ… å­˜åœ¨
  cleaning_duration_minutes integer DEFAULT 15,
  
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  
  -- é ç•™æ“´å±•æ¬„ä½
  metadata jsonb
);
```

### å•é¡Œæ¬„ä½å°ç…§

| ç¨‹å¼ç¢¼ä¸­ä½¿ç”¨çš„æ¬„ä½ | å¯¦éš›è³‡æ–™åº«æ¬„ä½ | ç‹€æ…‹ |
|---|---|---|
| `current_order_id` | **ä¸å­˜åœ¨** | âŒ éŒ¯èª¤ |
| `current_session_id` | `current_session_id` | âœ… æ­£ç¢º |
| `seated_at` | **ä¸å­˜åœ¨** | âŒ éŒ¯èª¤ |
| `last_occupied_at` | `last_occupied_at` | âœ… æ­£ç¢º |
| `customer_count` | **ä¸å­˜åœ¨** | âŒ éŒ¯èª¤ |
| `cleaning_started` | **ä¸å­˜åœ¨** | âŒ éŒ¯èª¤ |
| `maintenance_started` | **ä¸å­˜åœ¨** | âŒ éŒ¯èª¤ |
| `reserved_at` | **ä¸å­˜åœ¨** | âŒ éŒ¯èª¤ |

## âœ… å·²å®Œæˆçš„ä¿®å¾©

### 1. Store ä¸­çš„ updateTableStatus å‡½æ•¸

#### ä¿®å¾©å‰
```typescript
case 'available':
  updateData.current_order_id = null    // âŒ æ¬„ä½ä¸å­˜åœ¨
  updateData.customer_count = null      // âŒ æ¬„ä½ä¸å­˜åœ¨
  updateData.seated_at = null           // âŒ æ¬„ä½ä¸å­˜åœ¨
  break
case 'occupied':
  if (metadata.orderId) {
    updateData.current_order_id = metadata.orderId  // âŒ æ¬„ä½ä¸å­˜åœ¨
  }
  if (metadata.customer_count) {
    updateData.customer_count = metadata.customer_count  // âŒ æ¬„ä½ä¸å­˜åœ¨
  }
  break
```

#### ä¿®å¾©å¾Œ
```typescript
case 'available':
  updateData.last_cleaned_at = now
  updateData.current_session_id = null     // âœ… æ­£ç¢ºæ¬„ä½
  updateData.last_occupied_at = null       // âœ… æ­£ç¢ºæ¬„ä½
  break
case 'occupied':
  updateData.last_occupied_at = now        // âœ… æ­£ç¢ºæ¬„ä½
  if (metadata.sessionId) {
    updateData.current_session_id = metadata.sessionId  // âœ… æ­£ç¢ºæ¬„ä½
  }
  break
```

### 2. TypeScript é¡å‹å®šç¾©æ›´æ–°

#### ä¿®å¾©å‰
```typescript
export interface Table {
  // ... å…¶ä»–æ¬„ä½
  customer_count?: number      // âŒ ä¸å­˜åœ¨
  seated_at?: string          // âŒ ä¸å­˜åœ¨
  orderId?: string            // âŒ ä¸å­˜åœ¨
  cleaning_started?: string   // âŒ ä¸å­˜åœ¨
  maintenance_started?: string // âŒ ä¸å­˜åœ¨
  reserved_at?: string        // âŒ ä¸å­˜åœ¨
}
```

#### ä¿®å¾©å¾Œ
```typescript
export interface Table {
  id: string
  restaurant_id: string
  table_number: number
  name?: string
  capacity?: number
  min_capacity?: number
  max_capacity?: number
  
  // ç‹€æ…‹ç®¡ç†
  status?: 'available' | 'occupied' | 'reserved' | 'cleaning' | 'maintenance' | 'inactive'
  
  // ä½ç½®è³‡è¨Š
  floor_level?: number
  zone?: string
  position_x?: number
  position_y?: number
  
  // æ¡Œå°å±¬æ€§
  table_type?: string
  features?: any // jsonb
  
  // QR Code é»é¤
  qr_code?: string
  qr_enabled?: boolean
  
  // æ™ºèƒ½åˆ†é…
  ai_assignment_priority?: number
  ai_features_score?: any // jsonb
  
  // ç‹€æ…‹è¿½è¹¤ - âœ… ä½¿ç”¨æ­£ç¢ºçš„æ¬„ä½
  current_session_id?: string
  last_occupied_at?: string
  last_cleaned_at?: string
  cleaning_duration_minutes?: number
  
  is_active?: boolean
  created_at?: string
  updated_at?: string
  
  // é ç•™æ“´å±•æ¬„ä½
  metadata?: any // jsonb
  
  // å‹•æ…‹å±¬æ€§ï¼ˆæ¡Œå°ç®¡ç†é é¢ä½¿ç”¨ï¼‰
  order_number?: string
  [key: string]: any
}
```

### 3. æ¡Œå°ç®¡ç†é é¢çµ„ä»¶ä¿®å¾©

#### ä¿®å¾©å‰
```tsx
{table.seated_at && (      // âŒ æ¬„ä½ä¸å­˜åœ¨
  <div className="text-xs text-gray-600">
    å…¥åº§: {new Date(table.seated_at).toLocaleTimeString()}
  </div>
)}

// ç‹€æ…‹è®Šæ›´é‚è¼¯
metadata.orderId = null           // âŒ éŒ¯èª¤æ¬„ä½
metadata.customer_count = null    // âŒ éŒ¯èª¤æ¬„ä½
metadata.seated_at = null         // âŒ éŒ¯èª¤æ¬„ä½
```

#### ä¿®å¾©å¾Œ
```tsx
{table.last_occupied_at && (      // âœ… æ­£ç¢ºæ¬„ä½
  <div className="text-xs text-gray-600">
    æœ€å¾Œä½”ç”¨: {new Date(table.last_occupied_at).toLocaleTimeString()}
  </div>
)}

// ç‹€æ…‹è®Šæ›´é‚è¼¯
metadata.sessionId = null         // âœ… æ­£ç¢ºçš„é‚è¼¯
```

## ğŸ§ª ä¿®å¾©é©—è­‰

### æ¸¬è©¦é …ç›®
- [x] TypeScript ç·¨è­¯æ²’æœ‰éŒ¯èª¤
- [x] æ¡Œå°ç‹€æ…‹æ›´æ–°å‡½æ•¸ä½¿ç”¨æ­£ç¢ºçš„æ¬„ä½
- [x] ç•Œé¢é¡¯ç¤ºä½¿ç”¨æ­£ç¢ºçš„æ¬„ä½
- [x] æ•¸æ“šåº«æ“ä½œä¸æœƒå‡ºç¾æ¬„ä½ä¸å­˜åœ¨çš„éŒ¯èª¤

### é æœŸçµæœ
1. **æ¡Œå°ç‹€æ…‹è®Šæ›´åŠŸèƒ½æ­£å¸¸**ï¼šä¸å†å‡ºç¾ "Could not find column" éŒ¯èª¤
2. **è³‡æ–™åº«åŒæ­¥æ­£ç¢º**ï¼šç‹€æ…‹è®Šæ›´èƒ½æ­£ç¢ºå¯«å…¥è³‡æ–™åº«
3. **ç•Œé¢é¡¯ç¤ºæ­£å¸¸**ï¼šæ¡Œå°è³‡è¨Šæ­£ç¢ºé¡¯ç¤º
4. **TypeScript é¡å‹å®‰å…¨**ï¼šç·¨è­¯æ™‚æ²’æœ‰é¡å‹éŒ¯èª¤

## ğŸ¯ æ¸¬è©¦å»ºè­°

1. **åŠŸèƒ½æ¸¬è©¦**
   ```bash
   # å•Ÿå‹•æ‡‰ç”¨
   npm run dev
   
   # è¨ªå• http://localhost:5181/
   # é€²å…¥æ¡Œå°ç®¡ç†é é¢
   # æ¸¬è©¦ç‹€æ…‹è®Šæ›´åŠŸèƒ½
   ```

2. **æª¢æŸ¥é»**
   - âœ… æ¡Œå°åˆ—è¡¨æ­£å¸¸è¼‰å…¥
   - âœ… ç‹€æ…‹è®Šæ›´ä¸æœƒå‡ºç¾éŒ¯èª¤
   - âœ… æ§åˆ¶å°æ²’æœ‰è³‡æ–™åº«éŒ¯èª¤
   - âœ… æ¡Œå°è³‡è¨Šæ­£ç¢ºé¡¯ç¤º

## ğŸ“š å­¸åˆ°çš„ç¶“é©—

### é‡è¦æ•™è¨“
1. **å…ˆæª¢æŸ¥çœŸå¯¦çš„è³‡æ–™åº«çµæ§‹**ï¼šåœ¨ç·¨å¯«ç¨‹å¼ç¢¼å‰æ‡‰è©²ç¢ºèªå¯¦éš›çš„è¡¨çµæ§‹
2. **API èˆ‡å¯¦éš›è¡¨çµæ§‹åŒæ­¥**ï¼šç¨‹å¼ç¢¼æ‡‰è©²èˆ‡å¯¦éš›éƒ¨ç½²çš„è³‡æ–™åº«ä¿æŒä¸€è‡´
3. **é¡å‹å®šç¾©è¦ç²¾ç¢º**ï¼šTypeScript é¡å‹æ‡‰è©²åæ˜ å¯¦éš›çš„è³‡æ–™çµæ§‹
4. **éŒ¯èª¤è¨Šæ¯å¾ˆé‡è¦**ï¼šä»”ç´°é–±è®€éŒ¯èª¤è¨Šæ¯èƒ½å¿«é€Ÿå®šä½å•é¡Œ

### æœ€ä½³å¯¦è¸
1. **ä½¿ç”¨ SQL æ–‡ä»¶ä½œç‚ºçœŸå¯¦ä¾†æº**ï¼šä»¥å¯¦éš›çš„ SQL å»ºè¡¨èªå¥ç‚ºæº–
2. **å®šæœŸåŒæ­¥é¡å‹å®šç¾©**ï¼šç•¶è³‡æ–™åº«çµæ§‹è®Šæ›´æ™‚ï¼ŒåŠæ™‚æ›´æ–° TypeScript é¡å‹
3. **æ¸¬è©¦è³‡æ–™åº«æ“ä½œ**ï¼šåœ¨é–‹ç™¼ç’°å¢ƒä¸­æ¸¬è©¦æ‰€æœ‰ CRUD æ“ä½œ
4. **è¨˜éŒ„çµæ§‹è®Šæ›´**ï¼šæ–‡æª”åŒ–è³‡æ–™åº«çµæ§‹çš„è®Šæ›´æ­·å²

## ğŸ‰ çµè«–

è¡¨çµæ§‹ä¸åŒ¹é…å•é¡Œå·²å®Œå…¨è§£æ±ºï¼ç¾åœ¨ï¼š

1. **ç¨‹å¼ç¢¼èˆ‡è³‡æ–™åº«å®Œå…¨åŒæ­¥**ï¼šæ‰€æœ‰æ¬„ä½åç¨±éƒ½æ­£ç¢º
2. **æ¡Œå°ç®¡ç†åŠŸèƒ½å®Œå…¨æ­£å¸¸**ï¼šç‹€æ…‹è®Šæ›´èƒ½æ­£ç¢ºåŸ·è¡Œ
3. **é¡å‹å®‰å…¨å¾—åˆ°ä¿è­‰**ï¼šTypeScript é¡å‹å®šç¾©ç²¾ç¢º
4. **ç‚ºæœªä¾†é–‹ç™¼å¥ å®šåŸºç¤**ï¼šå»ºç«‹äº†æ­£ç¢ºçš„è³‡æ–™å­˜å–æ¨¡å¼

ç³»çµ±ç¾åœ¨å¯ä»¥å®‰å…¨ç©©å®šåœ°é‹è¡Œï¼Œæ¡Œå°ç®¡ç†åŠŸèƒ½å®Œå…¨å¯ç”¨ï¼
